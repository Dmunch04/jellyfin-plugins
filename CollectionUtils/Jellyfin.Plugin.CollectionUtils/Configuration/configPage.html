<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Collection Utils</title>
</head>
<body>
    <div id="CollectionUtilsConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form class="tbsConfigurationPage">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">Merge Versions</h2>
                        <a is="emby-linkbutton" class="raised button-alt headerHelpButton emby-button" target="_blank"
                           href="https://github.com/Dmunch04/jellyfin-plugins">Help</a>
                    </div>
                    <div class="verticalSection">
                        <p>hello</p>
                        <br />
                    </div>
                    <br />
                    <div>
                        <h3 class="checkboxListLabel">Enter names of collections to exclude from checking:</h3>
                        <div id="divTraktLocations" class="paperList checkboxList checkboxList-paperList">
                        </div>
                    </div>


                    <button is="emby-button" type="button" class="raised button-submit block emby-button"
                            id="refresh-library" onclick=save()><span>Save</span></button>

                    <button is="emby-button" type="button" class="raised block" id="refresh-library"
                            onclick=purgeEmptyCollections()><span>Purge Empty Collections</span></button>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var pluginId = "ee7d4525-d4e2-4612-8df9-2b76d0d63372"

            function purgeEmptyCollections() {
                var request = {
                    url: ApiClient.getUrl('CollectionUtil/PurgeEmptyCollections'),
                    type: 'POST'
                };

                ApiClient.fetch(request).then(function() {
                    Dashboard.alert("Purging empty collections...");
                }).catch(function() {
                    Dashboard.alert({message: "Unexpected error occurred!"});
                });
            }

            var config = undefined;

            ApiClient.getPluginConfiguration(pluginId).then(function(savedConfig) {
                config = savedConfig;

                if (!config) {
                    config.NamesExcluded = [];
                    config.DesiredCollectionSize = 3;
                }

                ApiClient.getVirtualFolders().then(function(virtualFolders) {
                    loadVirtualFolders(config, virtualFolders);
                });
            });

            function loadVirtualFolders(config, virtualFolders) {
                var page = $.mobile.activePage;
                var html = "";
                html += '<div data-role="controlgroup">';
                for (var i = 0, length = virtualFolders.length; i < length; i++) {
                    var virtualFolder = virtualFolders[i];
                    html += getFolderHtml(config, virtualFolder, i);
                }
                html += '</div>';
                $('#divTraktLocations', page).html(html).trigger('create');
            }

            function getFolderHtml(currentUserConfig, virtualFolder, index) {
                var html = "";
                for (var i = 0, length = virtualFolder.Locations.length; i < length; i++) {
                    var id = "chkFolder" + index + "_" + i;
                    var location = virtualFolder.Locations[i];
                    var isChecked = currentUserConfig.LocationsExcluded.filter(function (current) {
                        return current.toLowerCase() == location.toLowerCase();
                    }).length;
                    var checkedAttribute = isChecked ? 'checked="checked"' : "";
                    html += '<label><input is="emby-checkbox" class="chkLibrary" type="checkbox" data-mini="true" id="' + id + '" name="' + id + '" data-location="' + location + '" ' + checkedAttribute + ' /><span>' + location + " - " + virtualFolder.Name + '</span></label>';
                }
                return html;
            }


            function save() {
                var folders = $('.chkLibrary:checked').map(function () {
                    return this.getAttribute('data-location');
                }).get();

                ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                    config.LocationsExcluded = folders;
                    ApiClient.updatePluginConfiguration(pluginId, config).then(function (res) {
                        Dashboard.processPluginConfigurationUpdateResult(res);
                    });
                });
            }

            $('.traktConfigurationPage').on('pageinit', function () {
                var page = this;
                $('#traktConfigurationForm', page).on('submit', function () {
                    save();
                    return false;
                });
            });
        </script>
    </div>
</body>
</html>
